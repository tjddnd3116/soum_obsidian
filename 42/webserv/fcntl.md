# fcntl
## 1. 소개
- 유닉스의 모든것은 파일로 이루어져 있다.
- 일반 파일은 물론이고 네트워크 프로그래밍시 소켓을 다룰때 IPC, 디바이스등을 다루는 모든 것이 결국은 파일을 다루는 것들이다.
- fcntl은 이러한 파일들의 특성 제어를 위해 제공하는 함수이다.

## 2. fcntl 을 이요한 파일 제어
- fcntl 시스템콜은 이미 열려있는 파일의 특성 제어를 위해서 사용된다.
``` c
#include <unistd.h>
#include <fcntl.h>

int fcntl(int fd, int cmd);
int fcntl(int fd, int cmd, long arg);
int fcntl(int fd, int cmd, struct flock *lock);
```
- 첫번째 인자로 주어지는 fd는 open(2), socket(2)등의 시스템 콜을 통해서 만들어진 파일디스크립터이다.
- 두번째 인자인 cmd가 fd에 대한 특성을 제어하기 위한 값이다.

## 2.1 fcntl 로 할수 있는 일들
- fcntl 로 할수 있는 일들은 결국 cmd에 의해서 결정된다고 볼 수 있다. 대략적으로 할 수 있는 일들은 다음과 같다.
- F_DUPFD
	- 파일 디스크립터를 복사하기 위해서 사용한다.
	- dup2는 복사될 파일 디스크립터를 사용자가 지시하는 반면
	- F_DUPFD를 사용할경우 arg와 같은 크기의 파일 디스크립터를 리턴하거나 이미 사용되어지고 있다면 arg보다 큰 할당가능한 파일디스크립터 번호중 가장 작은 번호를 리턴한다.
	- 이 복사된 파일디스크립터는 잠금, 파일위치 포인터, 플래그 등을 공유한다. 즉 파일디스크립터들중 하나에서 파일의 위치가 변경되다면 다른 파일 디스크립터도 변경된다.
	- 그렇지만 close-on-exec 는 공유하지 않는다.

- F_GETFD
	- 리턴 값으로 fd에 대한 flag값을 넘겨준다. 현재는 FD_CLOEXEC정보만 넘겨준다.

- F_SETFD
	- FD_CLOEXEC(close-on-exec)의 값을 지정된 비트값으로 설정한다.

- F_GETFL
	- 파일 디스크립터에 대한 플래그값 (open(2)호출시 지정한 플래그)를 되돌려준다.

- F_SETFL
	- arg에 지정된 값으로 파일 지정자 fd의 플래그를 재 설정한다. 현재는 단지 O_APPEND, O_NONBLOCK, O_ASYNC 만을 설정할 수 있다. 다른 플래그들 (O_WRONLY 같은)은 영향을 받지 않는다.

- F_GETOWN
	- 이것은 비동기 입출력과 관련되어서 사용되며, SIGIO와 SIGURG 신호를 받는 프로세스 아이디를 얻기 위해서 사용된다.

- F_SETOWN
	- 비동기 입출력과 관련되어서 사용되며, SIGIO, SIGURG 시그널을 수신하는 프로세스 아이디(혹은 그룹) 을 설정하기 위해서 사용된다.

## 2.2 close-on-exec
- 보통 프로세스에서 exec(3)을 시켜서 새로운 프로세스를 실행시키면 이 새로운 프로세스는 기존의 프로세스의 이미지를 덮어쓰게 된다.
- 그러면서 특별한 설정이 없을경우 열린 파일디스크립터를 그대로 넘겨주게 된다.
- 때때로 exec를 이용해서 프로세스를 만들기전에 기존에 열렸던 파일 디스크립터들을 깨끗하게 정리하고 싶을때가 있다.
- 이러한 경우 close-on-exec 시킨다고 말하며 fcntl을 이용해서 열린 파일 디스크립터에 대해서 close-on-exec 작동을 하도록 할 수 있다.

#webserv 